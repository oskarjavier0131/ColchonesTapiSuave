{% extends 'base.html' %}
{% load image_tags %}

{% block title %}Productos - ColchonesTapiSuave{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <!-- Filtros laterales -->
        <div class="col-lg-3">
            <div class="filters-sidebar">
                <!-- ... filtros existentes ... -->
            </div>
        </div>
        
        <div class="col-lg-9">
            <div class="products-grid">
                <div class="row g-4">
                    {% for producto in page_obj %}
                    <div class="col-xl-4 col-lg-6 col-md-6 mb-4">
                        <div class="product-card h-100" data-product-id="{{ producto.id }}">
                            <div class="product-image">
                                {% responsive_product_image producto size='card' alt=producto.nombre css_class='product-img' %}
                                
                                {% if producto.get_descuento_porcentaje %}
                                <div class="product-badge">-{{ producto.get_descuento_porcentaje }}%</div>
                                {% endif %}
                                
                                <div class="image-loader">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="product-info">
                                <h5 class="product-title">{{ producto.nombre }}</h5>
                                <p class="text-muted small mb-3">{{ producto.descripcion_corta|truncatechars:60 }}</p>
                                
                                <div class="product-specs mb-3">
                                    <small class="text-muted">
                                        <i class="fas fa-expand-arrows-alt me-1"></i>{{ producto.get_tamano_display }}
                                        <span class="mx-2">•</span>
                                        <i class="fas fa-hand-paper me-1"></i>{{ producto.get_firmeza_display }}
                                    </small>
                                </div>
                                
                                <div class="product-price">
                                    {% if producto.precio_descuento %}
                                    <span class="product-price-old">{{ producto.precio|formato_peso_colombiano }}</span>
                                    {% endif %}
                                    {{ producto.get_precio_final|formato_peso_colombiano }}
                                </div>
                                
                                <div class="product-actions mt-auto">
                                    <a href="{{ producto.get_absolute_url }}" class="btn btn-outline-primary w-100 mb-2">
                                        <i class="fas fa-eye me-2"></i>Ver Detalles
                                    </a>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <button class="btn btn-sm btn-outline-secondary w-100 favorite-btn">
                                                <i class="far fa-heart"></i>
                                            </button>
                                        </div>
                                        <div class="col-6">
                                            <button class="btn btn-sm btn-outline-primary w-100 comparison-add-btn">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-search" style="font-size: 3rem; color: var(--border-color);"></i>
                        <h4 class="mt-3 text-muted">No se encontraron productos</h4>
                        <p class="text-muted">Prueba ajustando los filtros de búsqueda</p>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Paginación -->
                {% if page_obj.has_other_pages %}
                <nav aria-label="Paginación de productos" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.categoria %}&categoria={{ request.GET.categoria }}{% endif %}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">
                                <i class="fas fa-chevron-left"></i> Anterior
                            </a>
                        </li>
                        {% endif %}
                        
                        {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}{% if request.GET.categoria %}&categoria={{ request.GET.categoria }}{% endif %}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">{{ num }}</a>
                        </li>
                        {% endif %}
                        {% endfor %}
                        
                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.categoria %}&categoria={{ request.GET.categoria }}{% endif %}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">
                                Siguiente <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- CSS específico para carga de imágenes -->
<style>
.product-image {
    position: relative;
    overflow: hidden;
    border-radius: 15px 15px 0 0;
}

.product-img {
    transition: opacity 0.3s ease, transform 0.3s ease;
}

.product-img.lazy {
    opacity: 0;
}

.product-img.loaded {
    opacity: 1;
}

.image-loader {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: none;
}

.product-image:has(.lazy) .image-loader {
    display: block;
}

/* Skeleton loading para mejor UX */
.product-card.loading .product-image {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading-skeleton 1.5s infinite;
}

@keyframes loading-skeleton {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}
</style>
{% endblock %}